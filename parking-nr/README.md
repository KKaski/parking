# parking-nr
This is the microservices runtime for the parking demo. 

It contains services to retrieve data from the integrated parking systems as well as the Watson 
related image capturing and training capabilities.

##Deploy
[![Deploy to Bluemix](https://bluemix.net/deploy/button.png)](https://bluemix.net/deploy?repository=https://github.com/KKaski/parking.git/parking-nr#[required])

##Bluemix environment variables
Define the following environment variables

1. NODE_RED_USERNAME
2. NODE_RED_PASSWORD
3. NODE_TLS_REJECT_UNAUTHORIZED (0)
4. PLUGIT_USERNAME
5. PLUGIT_PASSWORD


##Service bindings
1. Bind the mongodb service created with parking-gui to the application
2. Create Watson Visual Recognition service and bind it to the application
3. Create dashDB service and bind it to the application (only needed for analytics)

##Code changes
These code changes has been done to the boilerplate code (no need to do).
1. bluemix-settings.js
There is a change in this file to allow node-red flow to use jimp for cropping and to get 
access to the environment variable in Bluemix

   //This is required to add jimp functionality to the code
    functionGlobalContext: { Jimp : require("jimp"), process: process},

##Flows
The following JSON snippets are the code for the actual service implementation. Each subheader includes the coode for the tab.
Teh core functionality is divided in three different tabs. Control GUI is the place where the data is writne to Mongo DB for GUIto update
the status. Plugit is the main flow to read the data from the Plugit API. The last tab is WAtson which is the microservice used for 
to call the classifiers for the random test image.

###Control GUI
[{"id":"689c04bd.05f68c","type":"mongodb in","z":"6f1a832.6d2fb7c","service":"parking-mongodb","mongodb":"","name":"Get Data","collection":"parking","operation":"find","x":458.75,"y":403.75,"wires":[["4cc69c9e.830e54"]]},{"id":"5b5da371.1aa25c","type":"inject","z":"6f1a832.6d2fb7c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":142.75,"y":471.75,"wires":[["4cc69c9e.830e54","c7896825.530bb"]]},{"id":"4cc69c9e.830e54","type":"debug","z":"6f1a832.6d2fb7c","name":"","active":true,"console":"false","complete":"false","x":620.75,"y":470,"wires":[]},{"id":"c7896825.530bb","type":"function","z":"6f1a832.6d2fb7c","name":"","func":"msg.limit = 100;\nreturn msg;","outputs":1,"noerr":0,"x":284.75,"y":403.25,"wires":[["689c04bd.05f68c"]]},{"id":"3def3408.38259c","type":"mongodb out","z":"6f1a832.6d2fb7c","service":"parking-mongodb","mongodb":"","name":"Clear data","collection":"parking","payonly":false,"upsert":false,"multi":false,"operation":"delete","x":405.75,"y":596.75,"wires":[]},{"id":"888cc510.5b399","type":"inject","z":"6f1a832.6d2fb7c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":147.75,"y":596.75,"wires":[["3def3408.38259c","1636e673.3d4702"]]},{"id":"1636e673.3d4702","type":"debug","z":"6f1a832.6d2fb7c","name":"","active":true,"console":"false","complete":"false","x":397.75,"y":552,"wires":[]},{"id":"d89899ee.cfac4","type":"mongodb out","z":"6f1a832.6d2fb7c","service":"parking-mongodb","mongodb":"","name":"Update","collection":"parking","payonly":true,"upsert":false,"multi":false,"operation":"update","x":723.75,"y":796,"wires":[]},{"id":"5041ea74.b99c0c","type":"mongodb in","z":"6f1a832.6d2fb7c","service":"parking-mongodb","mongodb":"","name":"GetData","collection":"parking","operation":"find","x":398.75,"y":746,"wires":[["d2d48e83.0bb008"]]},{"id":"5eb6983f.518bb","type":"inject","z":"6f1a832.6d2fb7c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":127.75,"y":739,"wires":[["81077053.8f9458"]]},{"id":"d2d48e83.0bb008","type":"function","z":"6f1a832.6d2fb7c","name":"Add spaces","func":"msg.payload.forEach(function add(space){\n        if(space.name===\"P3\")\n        {\n            space.places++;\n            node.send({payload:space});\n        }\n});\n\nreturn null;","outputs":1,"noerr":0,"x":564.75,"y":746.5,"wires":[["d89899ee.cfac4","161b06e3.081831"]]},{"id":"161b06e3.081831","type":"debug","z":"6f1a832.6d2fb7c","name":"","active":true,"console":"false","complete":"payload","x":737.75,"y":701.25,"wires":[]},{"id":"81077053.8f9458","type":"function","z":"6f1a832.6d2fb7c","name":"","func":"msg.limit=100;\nreturn msg;","outputs":1,"noerr":0,"x":260.75,"y":804.5,"wires":[["5041ea74.b99c0c"]]},{"id":"52fea575.fedcb4","type":"function","z":"6f1a832.6d2fb7c","name":"Populate example data","func":"var P3 = {name:\"P3\",order:1,places:5};\nvar P5 = {name:\"P5\",order:2,places:2};\nvar P10 = {name:\"P10\",order:3,places:8};\n\nnode.send({payload:P3});\nnode.send({payload:P5});\nnode.send({payload:P10});\n\nreturn null;","outputs":1,"noerr":0,"x":372.75,"y":929.5,"wires":[["a2f791ea.b676e","3eb494b4.bef46c"]]},{"id":"4e9932d3.6b77dc","type":"inject","z":"6f1a832.6d2fb7c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":130.75,"y":928,"wires":[["52fea575.fedcb4"]]},{"id":"a2f791ea.b676e","type":"mongodb out","z":"6f1a832.6d2fb7c","service":"parking-mongodb","mongodb":"","name":"Insert","collection":"parking","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":574.75,"y":932,"wires":[]},{"id":"ac9a191e.2f09","type":"comment","z":"6f1a832.6d2fb7c","name":"Populate example data","info":"","x":145.75,"y":884.5,"wires":[]},{"id":"3cd0bfe5.bb472","type":"comment","z":"6f1a832.6d2fb7c","name":"Add spaces example","info":"","x":143.75,"y":695.5,"wires":[]},{"id":"faef415b.bb773","type":"comment","z":"6f1a832.6d2fb7c","name":"Clear the data","info":"","x":129.75,"y":546.5,"wires":[]},{"id":"cfb513b8.a4a1e","type":"comment","z":"6f1a832.6d2fb7c","name":"Get current status","info":"","x":159.75,"y":349.5,"wires":[]},{"id":"5dcaa3bd.9c1924","type":"mongodb out","z":"6f1a832.6d2fb7c","service":"parking-mongodb","mongodb":"","name":"Update","collection":"parking","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":563,"y":114.99998474121094,"wires":[]},{"id":"bd6b64bd.0ed5b8","type":"function","z":"6f1a832.6d2fb7c","name":"Set spaces","func":"var P3 = {name:\"P3\",order:1,places:msg.status.payload.P3};\nvar P5 = {name:\"P5\",order:2,places:msg.status.payload.P5};\nvar P10 = {name:\"P10\",order:3,places:msg.status.payload.P10};\n\nnode.send({payload:P3});\nnode.send({payload:P5});\nnode.send({payload:P10});\n\nreturn null;","outputs":1,"noerr":0,"x":375,"y":112.49998474121094,"wires":[["5dcaa3bd.9c1924","2455d168.07efa6"]]},{"id":"2455d168.07efa6","type":"debug","z":"6f1a832.6d2fb7c","name":"","active":true,"console":"false","complete":"payload","x":577.75,"y":160.49998474121094,"wires":[]},{"id":"7147305e.15c49","type":"comment","z":"6f1a832.6d2fb7c","name":"Update GUI","info":"","x":156,"y":60.5,"wires":[]},{"id":"f430bc8e.5e2ca","type":"link in","z":"6f1a832.6d2fb7c","name":"updategui","links":["53209244.a8bd44"],"x":96.75003051757812,"y":115.74998474121094,"wires":[["78f1c045.7adff","bd6b64bd.0ed5b8"]]},{"id":"3eb494b4.bef46c","type":"debug","z":"6f1a832.6d2fb7c","name":"","active":true,"console":"false","complete":"false","x":594.75,"y":978.25,"wires":[]},{"id":"78f1c045.7adff","type":"mongodb out","z":"6f1a832.6d2fb7c","service":"parking-mongodb","mongodb":"","name":"remove","collection":"parking","payonly":false,"upsert":false,"multi":false,"operation":"delete","x":213.25,"y":175.24998474121094,"wires":[]}]

###Plugit
[{"id":"e8c3a38a.173c6","type":"inject","z":"c471c7f9.599e7","name":"","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":false,"x":120.5,"y":137,"wires":[["bdcf99c4.e95c5"]]},{"id":"8f202c36.70dfd","type":"http request","z":"c471c7f9.599e7","name":"","method":"POST","ret":"obj","url":"","tls":"81e5e296.52e178","x":331.5,"y":78,"wires":[["a6ebfec9.5914","6405a1a2.a9eb78"]]},{"id":"a6ebfec9.5914","type":"debug","z":"c471c7f9.599e7","name":"","active":true,"console":"false","complete":"true","x":496.5,"y":30,"wires":[]},{"id":"6405a1a2.a9eb78","type":"function","z":"c471c7f9.599e7","name":"","func":"//msg.payload = msg.payload.api_token;\nmsg.url =\"https://capi.plugitcloud.com/api/companies/97/plugs?api_token=\"+msg.payload.api_token+\"&format=full\";\nreturn msg;","outputs":1,"noerr":0,"x":497.7666015625,"y":84.14999389648438,"wires":[["f7a5e523.b02558","a383de7b.e2b878"]]},{"id":"f7a5e523.b02558","type":"debug","z":"c471c7f9.599e7","name":"","active":true,"console":"false","complete":"false","x":683.7666015625,"y":27.08331298828125,"wires":[]},{"id":"a383de7b.e2b878","type":"http request","z":"c471c7f9.599e7","name":"","method":"GET","ret":"txt","url":"","tls":"","x":686.5,"y":84,"wires":[["4ecfbfff.a85a","809b3c1b.1b0b28"]]},{"id":"48f6e393.0f7cb4","type":"debug","z":"c471c7f9.599e7","name":"","active":true,"console":"false","complete":"false","x":335.5,"y":419.75,"wires":[]},{"id":"e8e46ebd.a939a8","type":"cloudant out","z":"c471c7f9.599e7","name":"Store to cloudant","cloudant":"","database":"plugitchargers","service":"parking-nr-cloudantNoSQLDB","payonly":true,"operation":"insert","x":746.5,"y":254.5,"wires":[]},{"id":"a62445b3.c12af","type":"comment","z":"c471c7f9.599e7","name":"Get the data from the charger stations","info":"","x":187.5,"y":37,"wires":[]},{"id":"5f3809a7.d53d7","type":"http in","z":"c471c7f9.599e7","name":"Charger status","url":"/update","method":"get","swaggerDoc":"9d324672.740d6","x":114.5,"y":87.5,"wires":[["bdcf99c4.e95c5"]]},{"id":"4ecfbfff.a85a","type":"http response","z":"c471c7f9.599e7","name":"","x":891.5,"y":35.75,"wires":[]},{"id":"809b3c1b.1b0b28","type":"json","z":"c471c7f9.599e7","name":"","x":313.5,"y":296,"wires":[["48f6e393.0f7cb4","37723ac.1833f46"]]},{"id":"37723ac.1833f46","type":"function","z":"c471c7f9.599e7","name":"","func":"var P3=0,P5=0;P10=0;\n\nvar date = new Date();\n\n\n//node.warn(\"Start Processing\");\n\nmsg.payload.forEach(function(charger){\n    //If the charger is available increase availability\n    if(charger.status_id==1)\n    {\n        P10+= charger.name.search(/P10/i)>=0?1:0;\n        P3+= charger.name.search(/P3/i)>=0?1:0;\n        P5+= charger.name.search(/Karaportti [0-9]/i)>=0?1:0;\n    }\n});\n\nvar store = {payload:{datefull:date.toUTCString(),month:date.getUTCMonth(),\n            date:date.getUTCDate(),day:date.getUTCDay(),hours:date.getUTCHours(),\n            P3:P3,P5:P5,P10:P10}};\n\nreturn [store,{payload:P3},{payload:P5},{payload:P10},{status:store}];","outputs":"5","noerr":0,"x":529.5,"y":309,"wires":[["e8e46ebd.a939a8"],["4f48ee1b.1cf1c8"],["d6cb8784.422d48"],["134daa18.7c53ce"],["53209244.a8bd44"]]},{"id":"4f48ee1b.1cf1c8","type":"ui_gauge","z":"c471c7f9.599e7","name":"P3","group":"ffaf3117.586e9","order":0,"width":"3","height":"3","gtype":"donut","title":"P3","label":"units","format":"{{value}}","min":0,"max":10,"colors":["#00b500","#e6e600","#ca3838"],"x":703.5,"y":306.75,"wires":[]},{"id":"d6cb8784.422d48","type":"ui_gauge","z":"c471c7f9.599e7","name":"P5","group":"ffaf3117.586e9","order":0,"width":"3","height":"3","gtype":"compass","title":"P5","label":"units","format":"{{value}}","min":0,"max":10,"colors":["#00b500","#e6e600","#ca3838"],"x":701.5,"y":351.75,"wires":[]},{"id":"134daa18.7c53ce","type":"ui_gauge","z":"c471c7f9.599e7","name":"P10","group":"ffaf3117.586e9","order":0,"width":"3","height":"3","gtype":"compass","title":"P10","label":"units","format":"{{value}}","min":0,"max":10,"colors":["#00b500","#e6e600","#ca3838"],"x":698.5,"y":396.75,"wires":[]},{"id":"fc2d1c1c.56f2f","type":"comment","z":"c471c7f9.599e7","name":"Process the data","info":"","x":122.5,"y":291,"wires":[]},{"id":"a2ecd02c.d73878","type":"comment","z":"c471c7f9.599e7","name":"Put data with timestamp to Cloudant for analytics","info":"","x":771.5,"y":207,"wires":[]},{"id":"53209244.a8bd44","type":"link out","z":"c471c7f9.599e7","name":"","links":["f430bc8e.5e2ca"],"x":624,"y":450.5,"wires":[]},{"id":"3a2732f8.0bc956","type":"comment","z":"c471c7f9.599e7","name":"Update GUI","info":"","x":724,"y":452,"wires":[]},{"id":"bdcf99c4.e95c5","type":"function","z":"c471c7f9.599e7","name":"","func":"var process = global.get('process');\nvar username = process.env.PLUGIT_USERNAME;\nvar password = process.env.PLUGIT_PASSWORD;\n\nmsg.url = \"https://capi.plugitcloud.com/auth/login?username=\"+username+\"&password=\"+password;\nreturn msg;","outputs":1,"noerr":0,"x":285.5,"y":135,"wires":[["8f202c36.70dfd"]]},{"id":"81e5e296.52e178","type":"tls-config","z":"","name":"CA added","cert":"","key":"","ca":"","verifyservercert":false},{"id":"9d324672.740d6","type":"swagger-doc","z":"","summary":"","description":"","tags":"","consumes":"","produces":"","parameters":[],"responses":{},"deprecated":false},{"id":"ffaf3117.586e9","type":"ui_group","z":"","name":"Parking","tab":"e89b0ec9.51cfd","disp":true,"width":"9"},{"id":"e89b0ec9.51cfd","type":"ui_tab","z":"","name":"Home","icon":"dashboard"}]

###Watson
[{"id":"3edccf49.a70d5","type":"visual-recognition-util-v3","z":"172e6375.27112d","name":"Get Classifiers","apikey":"","image-feature":"retrieveClassifiersList","x":436.5,"y":71,"wires":[["e505f89b.7aa018"]]},{"id":"cbc28d9d.cd61e8","type":"inject","z":"172e6375.27112d","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":142.5,"y":71.5,"wires":[["3edccf49.a70d5"]]},{"id":"e505f89b.7aa018","type":"debug","z":"172e6375.27112d","name":"","active":true,"console":"false","complete":"result","x":698.5,"y":72.75,"wires":[]},{"id":"260f42b9.5d4a96","type":"function","z":"172e6375.27112d","name":"Random image","func":"msg.output=\"\";\nif(msg.payload.output!==undefined)\n    msg.output=msg.payload.output;\n\nvar id = Math.floor(Math.random()*100);\nmsg.payload = \"https://parking-nr.mybluemix.net/examples/\"+id+\".jpg\";\n//msg = {payload:\"http://frames.timespace.co/640889740/fi/frame_service/\"};\n\nmsg.params={};\nmsg.params[\"classifier_ids\"]=\"freeparking_109695454\";\nmsg.params[\"threshold\"]=\"0.0\";\nmsg.params[\"owners\"]=\"me,IBM\";\n\nreturn msg;","outputs":1,"noerr":0,"x":300.5,"y":343,"wires":[["39301a6b.eb95ae","c33437e6.6271a"]]},{"id":"39301a6b.eb95ae","type":"debug","z":"172e6375.27112d","name":"","active":true,"console":"false","complete":"true","x":479.5,"y":283.75,"wires":[]},{"id":"a41df3b8.cf7b38","type":"template","z":"172e6375.27112d","name":"Result","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<!DOCTYPE html|>\n<html>\n<head>\n</head>\n<body>\n\nScoring of free spaces: {{payload.score}}\n\n<img src=\"{{payload.url}}\">\n\n</body>\n</html>","x":386.5,"y":529,"wires":[["cd893b75.056e3","905e21c4.a7c3b"]]},{"id":"cd893b75.056e3","type":"debug","z":"172e6375.27112d","name":"","active":true,"console":"false","complete":"output","x":548.5,"y":537.75,"wires":[]},{"id":"c33437e6.6271a","type":"visual-recognition-v3","z":"172e6375.27112d","name":"Free ?","apikey":"","image-feature":"classifyImage","lang":"en","x":500.5,"y":342,"wires":[["94380998.ee2e68"]]},{"id":"94380998.ee2e68","type":"function","z":"172e6375.27112d","name":"","func":"msg.payload = {score:msg.result.images[0].classifiers[0].classes[0].score,\n        url:msg.result.images[0].source_url};\n\nreturn msg;","outputs":1,"noerr":0,"x":123.5,"y":483,"wires":[["e5399896.21ea2"]]},{"id":"5104bb8a.31be0c","type":"http in","z":"172e6375.27112d","name":"","url":"/simulate","method":"get","swaggerDoc":"","x":113.5,"y":343.5,"wires":[["260f42b9.5d4a96"]]},{"id":"905e21c4.a7c3b","type":"http response","z":"172e6375.27112d","name":"result","x":533.5,"y":479.75,"wires":[]},{"id":"b2c99129.8c3c3","type":"inject","z":"172e6375.27112d","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":131.5,"y":138.5,"wires":[["e9b50a7c.775a88"]]},{"id":"70494f32.8dd8b","type":"visual-recognition-util-v3","z":"172e6375.27112d","name":"Delete Classifier","apikey":"","image-feature":"deleteClassifier","x":454.5,"y":139,"wires":[["f59426a5.268fc8"]]},{"id":"f59426a5.268fc8","type":"debug","z":"172e6375.27112d","name":"","active":true,"console":"false","complete":"false","x":681.5,"y":139.75,"wires":[]},{"id":"e9b50a7c.775a88","type":"function","z":"172e6375.27112d","name":"","func":"msg.params={};\nmsg.params[\"classifier_id\"]=\"freeparking_109695454\";\n\nreturn msg;","outputs":1,"noerr":0,"x":273.5,"y":140,"wires":[["70494f32.8dd8b"]]},{"id":"8535adb4.a6da9","type":"comment","z":"172e6375.27112d","name":"Watson image classifier","info":"","x":141.75,"y":272,"wires":[]},{"id":"4243c920.00d8e","type":"http in","z":"172e6375.27112d","name":"","url":"/koe","method":"get","swaggerDoc":"","x":152.5,"y":636.5,"wires":[["ceb2c934.3924d8","1c0f3378.5cd325"]]},{"id":"ceb2c934.3924d8","type":"debug","z":"172e6375.27112d","name":"","active":true,"console":"false","complete":"false","x":403.5,"y":639.75,"wires":[]},{"id":"1c0f3378.5cd325","type":"http response","z":"172e6375.27112d","name":"","x":393.5,"y":696.75,"wires":[]},{"id":"e5399896.21ea2","type":"switch","z":"172e6375.27112d","name":"","property":"output","propertyType":"msg","rules":[{"t":"eq","v":"json","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":256.5,"y":485,"wires":[["905e21c4.a7c3b"],["a41df3b8.cf7b38"]]}]

##Watson training
The image material used for the Watson Visual Recognition service can be found under the 
public/training folder. From the folder you can find the original images as well as the precreated .zip packages
which are used o train th Watson service.

Easiest way to train Watson is by usin curl from the command line.

1. Create new Watson Visual Recognition service and bind it to you Node-Red runtime
2. Copy the API keys from your service
3. Change to the directory where the training images are stored.
4. Use the following command (replace <yourkey> qith your api key)

curl -X POST -F freeparking_positive_examples=@Positive.zip -F negative_examples=@Negative.zip -F name=freeparking "https://gateway-a.watsonplatform.net/visual-recognition/api/v3/classifiers?api_key=<yourkey>&version=2016-05-20"